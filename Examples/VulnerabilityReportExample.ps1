Import-Module PSNessusAPI

# get all folders
$folders = Get-PSNessusFolders

# Loop through all $folders.folders and get all scans based on $folders.folders.id
# Get all vulnerabilities based on $scans.scans.id
foreach ($folder in $folders.folders) {
    $scans = Get-PSNessusScans -FolderId $folder.id

    # Loop through all $scans.scans and get all vulnerabilities based on $scans.scans.id
    foreach ($scan in $scans.scans) {
        $vulnerabilities = Get-PSNessusScanReport -ScanId $scan.id -ReportType "Vulnerabilities"

        # Loop through all $vulnerabilities.vulnerabilities and get all vulnerability information based on $vulnerabilities.vulnerabilities.plugin_id
        foreach ($vulnerability in $vulnerabilities.vulnerabilities) {
            if ($vulnerability.score -ge "6.9")
 {            $vulnerabilityInfo = Get-PSNessusScanVulnerability -ScanId $scan.id -VulnerabilityId $vulnerability.plugin_id
            $vulnerabilityInfo | ConvertTo-Json | Out-File -FilePath "$($scan.name)_$($vulnerability.plugin_id).json"
 }
        }
    }
}

# CVE numbers are stored here: $vulnerabilityInfo.info.plugindescription.pluginattributes.ref_information.ref.values.value
# CVE URLs are stored here: $vulnerabilityInfo.info.plugindescription.pluginattributes.ref_information.ref.url
# The URL needs to be joined with the CVE number:
# $cve = $vulnerabilityInfo.info.plugindescription.pluginattributes.ref_information.ref.values.value
# $cveUrl = $vulnerabilityInfo.info.plugindescription.pluginattributes.ref_information.ref.url
# $cveUrl = $cveUrl + $cve
